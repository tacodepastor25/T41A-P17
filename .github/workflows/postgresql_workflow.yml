name: Run PostgreSQL Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # Actualizado a v4

    - name: Set up Python
      uses: actions/setup-python@v5 # Actualizado a v5
      with:
        python-version: '3.10' # Usar una versión específica y compatible, como 3.10

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Wait for PostgreSQL
      # PostgreSQL v14 ya debe estar listo, se reduce el sleep.
      run: |
        sleep 5

    - name: Setup Database (Create Tables, Extensions, and Data)
      run: |
        # Definir la variable de entorno PGPASSWORD
        export PGPASSWORD=postgres
        
        # 1. Crear la tabla de usuarios (JSONB inicial)
        echo "--> Running 01_create_tables.sql"
        psql -h localhost -U postgres -d test_db -f 01_create_tables.sql
        
        # 2. Insertar datos iniciales de usuarios
        echo "--> Running 02_insert_data.sql"
        psql -h localhost -U postgres -d test_db -f 02_insert_data.sql
        
        # 3. Consultas y esquemas iniciales (incluye índice GIN para usuarios)
        echo "--> Running 03_query_data.sql"
        psql -h localhost -U postgres -d test_db -f 03_query_data.sql

        # 4. Crear tabla y extensión HSTORE (Necesario antes de insertar datos HSTORE)
        echo "--> Running 05_create_hstore.sql (Creates HSTORE extension and table)"
        psql -h localhost -U postgres -d test_db -f 05_create_hstore.sql
        
        # 5. Insertar datos en la tabla HSTORE
        echo "--> Running 06_insert_hstore_data.sql"
        psql -h localhost -U postgres -d test_db -f 06_insert_hstore_data.sql
        
        # 6. Ejecutar consultas y modificaciones de HSTORE (Intermedio/Básico)
        echo "--> Running 07_query_hstore.sql (Basic HSTORE queries/updates)"
        psql -h localhost -U postgres -d test_db -f 07_query_hstore.sql

        # 7. Crear/Insertar/Indexar tabla de productos JSONB
        echo "--> Running 10_jsonb_products.sql (JSONB products table/data/index)"
        psql -h localhost -U postgres -d test_db -f 10_jsonb_products.sql
        
        # 8. Ejecutar consultas de JSONB
        echo "--> Running 11_jsonb_queries.sql"
        psql -h localhost -U postgres -d test_db -f 11_jsonb_queries.sql
        
        # 9. Ejecutar ejercicios avanzados y funciones
        echo "--> Running 09_advanced_hstore.sql (Advanced HSTORE queries/functions)"
        psql -h localhost -U postgres -d test_db -f 09_advanced_hstore.sql
        
        # 10. Ejecutar ejercicios de conversión HSTORE/JSONB
        echo "--> Running 12_final_advanced.sql (HSTORE to JSONB conversion)"
        psql -h localhost -U postgres -d test_db -f 12_final_advanced.sql
        
        # 11. Ejecutar tests SQL (DO $$ blocks) para validación de datos
        # (Asumo que renombraste 04_unit_tests.sql a 08_unit_tests.sql o similar para la secuencia)
        echo "--> Running 08_unit_tests.sql (SQL Validation Blocks)"
        psql -h localhost -U postgres -d test_db -f 08_unit_tests.sql
        
    - name: Run Python unit tests
      run: |
        pytest -vv

